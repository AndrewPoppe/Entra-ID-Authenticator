{
    "name": "Entra ID Authenticator",
    "tt_name": "module_name",
    "namespace": "YaleREDCap\\EntraIdAuthenticator",
    "description": "This External Module enables SSO with multiple Entra ID tenants.",
    "tt_description": "module_description",
    "authors": [
        {
            "name": "Andrew Poppe",
            "email": "andrew.poppe@yale.edu",
            "institution": "Yale University"
        }
    ],
    "system-settings": [
        {
            "key": "general-section",
            "name": "general_section",
            "tt_name": "general_section",
            "type": "descriptive"
        },
        {
            "key": "custom-login-page-type",
            "name": "custom_login_page_type",
            "tt_name": "custom_login_page_type",
            "type": "radio",
            "required": true,
            "choices": [
                {
                    "value": "complete",
                    "name": "Complete Custom Page",
                    "tt_name": "complete_custom_page"
                },
                {
                    "value": "modified",
                    "name": "Modified Page",
                    "tt_name": "modified_page"
                },
                {
                    "value": "none",
                    "name": "SSO Only",
                    "tt_name": "page_type_none"
                }
            ]
        },
        {
            "key": "custom-login-page-background-image",
            "name": "custom_login_page_background_image",
            "tt_name": "custom_login_page_background_image",
            "type": "file",
            "required": true,
            "branchingLogic": {
                "field": "custom-login-page-type",
                "value": "complete"
            }
        },
        {
            "key": "custom-login-page-background-image-copyright-text",
            "name": "custom_login_page_background_image_copyright_text",
            "tt_name": "custom_login_page_background_image_copyright_text",
            "type": "text",
            "branchingLogic": {
                "field": "custom-login-page-type",
                "value": "complete"
            }
        },
        {
            "key": "custom-login-page-background-image-copyright-link",
            "name": "custom_login_page_background_image_copyright_link",
            "tt_name": "custom_login_page_background_image_copyright_link",
            "type": "text",
            "branchingLogic": {
                "field": "custom-login-page-type",
                "value": "complete"
            }
        },
        {
            "key": "create-new-users-on-login",
            "name": "create_new_users_on_login",
            "tt_name": "create_new_users_on_login",
            "type": "checkbox",
            "branchingLogic": {
                "type": "or",
                "conditions": [
                    {
                        "field": "custom-login-page-type",
                        "op": "=",
                        "value": "complete"
                    },
                    {
                        "field": "custom-login-page-type",
                        "op": "=",
                        "value": "modified"
                    }
                ]
            }
        },
        {
            "key": "convert-table-user-to-entraid-user",
            "name": "convert_table_user_to_entraid_user",
            "tt_name": "convert_table_user_to_entraid_user",
            "type": "checkbox",
            "branchingLogic": {
                "type": "or",
                "conditions": [
                    {
                        "field": "custom-login-page-type",
                        "op": "=",
                        "value": "complete"
                    },
                    {
                        "field": "custom-login-page-type",
                        "op": "=",
                        "value": "modified"
                    }
                ]
            }
        },
        {
            "key": "entraid-attestation-default",
            "name": "entraid_attestation_default",
            "tt_name": "entraid_attestation_default",
            "type": "radio",
            "choices": [
                {
                    "value": 0,
                    "name": "No Attestation",
                    "tt_name": "no_attestation"
                },
                {
                    "value": 1,
                    "name": "On account creation",
                    "tt_name": "attestation_at_creation"
                },
                {
                    "value": 2,
                    "name": "On every login (only if needed)",
                    "tt_name": "attestation_every_login"
                }
            ],
            "branchingLogic": {
                "type": "or",
                "conditions": [
                    {
                        "field": "custom-login-page-type",
                        "op": "=",
                        "value": "complete"
                    },
                    {
                        "field": "custom-login-page-type",
                        "op": "=",
                        "value": "modified"
                    }
                ]
            }
        },
        {
            "key": "entraid-attestation-text-default",
            "name": "entraid_attestation_text_default",
            "tt_name": "entraid_attestation_text_default",
            "type": "rich-text",
            "branchingLogic": {
                "type": "or",
                "conditions": [
                    {
                        "field": "custom-login-page-type",
                        "op": "=",
                        "value": "complete"
                    },
                    {
                        "field": "custom-login-page-type",
                        "op": "=",
                        "value": "modified"
                    }
                ]
            }
        },
        {
            "key": "entraid-attestation-checkbox-text-default",
            "name": "entraid_attestation_checkbox_text_default",
            "tt_name": "entraid_attestation_checkbox_text_default",
            "type": "text",
            "branchingLogic": {
                "type": "or",
                "conditions": [
                    {
                        "field": "custom-login-page-type",
                        "op": "=",
                        "value": "complete"
                    },
                    {
                        "field": "custom-login-page-type",
                        "op": "=",
                        "value": "modified"
                    }
                ]
            }
        },
        {
            "key": "entraid-attestation-version-default",
            "name": "entraid_attestation_version_default",
            "tt_name": "entraid_attestation_version_default",
            "type": "text",
            "branchingLogic": {
                "type": "or",
                "conditions": [
                    {
                        "field": "custom-login-page-type",
                        "op": "=",
                        "value": "complete"
                    },
                    {
                        "field": "custom-login-page-type",
                        "op": "=",
                        "value": "modified"
                    }
                ]
            }
        },
        {
            "key": "entraid-greater-section",
            "name": "entraid_greater_section",
            "tt_name": "entraid_greater_section",
            "type": "descriptive"
        },
        {
            "key": "entraid-site",
            "name": "entraid_site",
            "tt_name": "entraid_site",
            "type": "sub_settings",
            "repeatable": true,
            "sub_settings": [
                {
                    "key": "entraid-section",
                    "name": "entraid_section",
                    "tt_name": "entraid_section",
                    "type": "descriptive"
                },
                {
                    "key": "entraid-site-id",
                    "name": "<strong>Entra ID Site ID</strong>:<br>Randomly generated",
                    "type": "text"
                },
                {
                    "key": "entraid-label",
                    "name": "entraid_label",
                    "tt_name": "entraid_label",
                    "type": "text",
                    "required": true
                },
                {
                    "key": "entraid-auth-value",
                    "name": "entraid_auth_value",
                    "tt_name": "entraid_auth_value",
                    "type": "text",
                    "required": true
                },
                {
                    "key": "entraid-login-button-logo",
                    "name": "entraid_login_button_logo",
                    "tt_name": "entraid_login_button_logo",
                    "type": "file",
                    "branchingLogic": {
                        "type": "or",
                        "conditions": [
                            {
                                "field": "custom-login-page-type",
                                "op": "=",
                                "value": "complete"
                            },
                            {
                                "field": "custom-login-page-type",
                                "op": "=",
                                "value": "modified"
                            }
                        ]
                    }
                },
                {
                    "key": "entraid-ad-tenant-id",
                    "name": "entraid_ad_tenant_id",
                    "tt_name": "entraid_ad_tenant_id",
                    "type": "text"
                },
                {
                    "key": "entraid-client-id",
                    "name": "entraid_client_id",
                    "tt_name": "entraid_client_id",
                    "type": "text"
                },
                {
                    "key": "entraid-client-secret",
                    "name": "entraid_client_secret",
                    "tt_name": "entraid_client_secret",
                    "type": "password"
                },
                {
                    "key": "entraid-redirect-url",
                    "name": "entraid_redirect_url",
                    "tt_name": "entraid_redirect_url",
                    "type": "text"
                },
                {
                    "key": "entraid-redirect-url-spa",
                    "name": "entraid_redirect_url_spa",
                    "tt_name": "entraid_redirect_url_spa",
                    "type": "text"
                },
                {
                    "key": "entraid-logout-url",
                    "name": "entraid_logout_url",
                    "tt_name": "entraid_logout_url",
                    "type": "text"
                },
                {
                    "key": "entraid-allowed-groups",
                    "name": "entraid_allowed_groups",
                    "tt_name": "entraid_allowed_groups",
                    "type": "text",
                    "repeatable": true
                },
                {
                    "key": "entraid-attestation",
                    "name": "entraid_attestation",
                    "tt_name": "entraid_attestation",
                    "type": "radio",
                    "choices": [
                        {
                            "value": 0,
                            "name": "No Attestation",
                            "tt_name": "no_attestation"
                        },
                        {
                            "value": 1,
                            "name": "On account creation",
                            "tt_name": "attestation_at_creation"
                        },
                        {
                            "value": 2,
                            "name": "On every login (only if needed)",
                            "tt_name": "attestation_every_login"
                        }
                    ],
                    "branchingLogic": {
                        "type": "or",
                        "conditions": [
                            {
                                "field": "custom-login-page-type",
                                "op": "=",
                                "value": "complete"
                            },
                            {
                                "field": "custom-login-page-type",
                                "op": "=",
                                "value": "modified"
                            }
                        ]
                    }
                },
                {
                    "key": "entraid-attestation-text",
                    "name": "entraid_attestation_text",
                    "tt_name": "entraid_attestation_text",
                    "type": "rich-text",
                    "branchingLogic": {
                        "type": "or",
                        "conditions": [
                            {
                                "field": "custom-login-page-type",
                                "op": "=",
                                "value": "complete"
                            },
                            {
                                "field": "custom-login-page-type",
                                "op": "=",
                                "value": "modified"
                            }
                        ]
                    }
                },
                {
                    "key": "entraid-attestation-checkbox-text",
                    "name": "entraid_attestation_checkbox_text",
                    "tt_name": "entraid_attestation_checkbox_text",
                    "type": "text",
                    "branchingLogic": {
                        "type": "or",
                        "conditions": [
                            {
                                "field": "custom-login-page-type",
                                "op": "=",
                                "value": "complete"
                            },
                            {
                                "field": "custom-login-page-type",
                                "op": "=",
                                "value": "modified"
                            }
                        ]
                    }
                },
                {
                    "key": "entraid-attestation-version",
                    "name": "entraid_attestation_version",
                    "tt_name": "entraid_attestation_version",
                    "type": "text",
                    "branchingLogic": {
                        "type": "or",
                        "conditions": [
                            {
                                "field": "custom-login-page-type",
                                "op": "=",
                                "value": "complete"
                            },
                            {
                                "field": "custom-login-page-type",
                                "op": "=",
                                "value": "modified"
                            }
                        ]
                    }
                }
            ]
        },
        {
            "key": "scripts",
            "name": "<script>var moduleName = 'Entra ID Authenticator'; window.editors = window.editors ?? []; tinymce.on('AddEditor', (e) => { if (!window.editors.includes(e.editor.id) && document.querySelector('#external-modules-configure-modal span.module-name').textContent === moduleName) { window.editors.push(e.editor.id); console.log(tinymce.get(e.editor.id)); var css = app_path_webroot_full + 'redcap_v' + redcap_version + '/Resources/css/style.css'; if (!e.editor.initialized) { e.editor.on('init', () => e.editor.dom.loadCSS(css));} else {e.editor.dom.loadCSS(css)}}}); </script>",
            "type": "descriptive"
        }
    ],
    "crons": [
        {
            "cron_name": "entraid_authenticator_send_password_reset_emails",
            "cron_description": "This cron job sends password reset emails to users who have been converted to table-based users",
            "method": "sendPasswordResetEmails",
            "cron_frequency": "60",
            "cron_max_run_time": "60"
        }
    ],
    "links": {
        "control-center": [
            {
                "name": "Entra ID Authenticator",
                "icon": "assets/images/entraid-logo.svg",
                "url": "user_dashboard.php",
                "show-header-and-footer": true
            }
        ]
    },
    "auth-ajax-actions": [
        "getUserType",
        "convertTableUserToEntraIdUser",
        "convertTableUsersToEntraIdUsers",
        "convertEntraIdUsertoTableUser",
        "convertEntraIdUsersToTableUsers",
        "getEntraIdUsers",
        "handleAttestation"
    ],
    "no-auth-ajax-actions": [
        "handleAttestation"
    ],
    "no-auth-pages": [
        "entraid_sso_login",
        "logout"
    ],
    "enable-no-auth-logging": true,
    "enable-every-page-hooks-on-system-pages": true,
    "framework-version": 15,
    "compatibility": {
        "redcap-version-min": "14.0.31",
        "redcap-version-max": "",
        "php-version-min": "7.4.00",
        "php-version-max": "8.3.99"
    }
}